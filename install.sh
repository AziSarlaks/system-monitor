#!/bin/bash

# System Monitor Server - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº Ð·Ð°Ð¿ÑƒÑÐºÑƒ

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   System Monitor Server - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ð°
if ! command -v gcc &> /dev/null; then
    echo "âŒ GCC Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ð°..."
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐžÐ¡
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        if command -v apt &> /dev/null; then
            # Debian/Ubuntu
            sudo apt update
            sudo apt install -y gcc make
        elif command -v yum &> /dev/null; then
            # CentOS/RHEL
            sudo yum install -y gcc make
        elif command -v pacman &> /dev/null; then
            # Arch
            sudo pacman -S gcc make
        else
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ GCC. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ."
            exit 1
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if ! command -v xcode-select &> /dev/null; then
            xcode-select --install
        fi
    else
        echo "âŒ ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ð°Ñ ÐžÐ¡"
        exit 1
    fi
fi

echo "âœ… GCC Ð½Ð°Ð¹Ð´ÐµÐ½"

# ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ""
echo "ðŸ”§ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°..."
cd backend/src
gcc -o monitor_server main.c server.c proc_parser.c json_formatter.c history.c -lpthread -lm -D_GNU_SOURCE
mv monitor_server ..
cd ..
mv monitor_server ..
cd ..

if [ $? -eq 0 ]; then
    echo "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo ""
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°..."

cat > run.sh << 'EOF'
#!/bin/bash
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘      System Monitor Server v2.0         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð°
PORT=8080
if [ ! -z "$1" ]; then
    PORT=$1
fi

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ $PORT..."
echo "ðŸ“Š API: http://localhost:$PORT/api/system"
echo "ðŸ“ˆ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ: http://localhost:$PORT/api/history"
echo "ðŸ¥ Health: http://localhost:$PORT/api/health"
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
./monitor_server $PORT
EOF

chmod +x run.sh
echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ README
echo ""
echo "ðŸ“š Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ README..."

cat > README.txt << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 System Monitor Server v2.0                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ ÐžÐŸÐ˜Ð¡ÐÐÐ˜Ð•:
   Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
   ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ CPU, RAM, GPU Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹

ðŸš€ Ð—ÐÐŸÐ£Ð¡Ðš:
   ./run.sh [Ð¿Ð¾Ñ€Ñ‚]

   ÐŸÑ€Ð¸Ð¼ÐµÑ€: ./run.sh 8080

ðŸ“Š API ENDPOINTS:
   â€¢ http://localhost:8080/api/system  - Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
   â€¢ http://localhost:8080/api/history - Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ
   â€¢ http://localhost:8080/api/health   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ

ðŸ“ Ð¤ÐÐ™Ð›Ð«:
   â€¢ monitor_server    - Ð˜ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²ÐµÑ€Ð°
   â€¢ index.html        - Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
   â€¢ app.js            - JavaScript ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
   â€¢ style.css         - Ð¡Ñ‚Ð¸Ð»Ð¸ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°

ðŸŒ Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐÐ˜Ð•:
   1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€: ./run.sh
   2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ: index.html
   3. Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!

ðŸ›‘ ÐžÐ¡Ð¢ÐÐÐžÐ’ÐšÐ:
   ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ

âš™ï¸ Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð¯:
   â€¢ Linux Ð¸Ð»Ð¸ macOS
   â€¢ GCC ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€
   â€¢ Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ JavaScript

ðŸ’¡ ÐŸÐ Ð˜ÐœÐ•Ð§ÐÐÐ˜Ð¯:
   â€¢ Ð”Ð»Ñ GPU Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ NVIDIA GPU Ñ nvidia-smi
   â€¢ Ð”Ð»Ñ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ CPU Ð½ÑƒÐ¶Ð½Ñ‹ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ /sys/class/thermal
   â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² Ð´ÐµÐ¼Ð¾-Ñ€ÐµÐ¶Ð¸Ð¼Ðµ ÐµÑÐ»Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½

ðŸ“ž ÐŸÐžÐ”Ð”Ð•Ð Ð–ÐšÐ:
   â€¢ GitHub: https://github.com/AziSarlaks/system-monitor/issues
   â€¢ Email: azisarlaks@gmail.com
EOF

echo "âœ… README ÑÐ¾Ð·Ð´Ð°Ð½"

# Ð˜Ñ‚Ð¾Ð³
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ:"
echo "   1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€: ./run.sh"
echo "   2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ Ñ„Ð°Ð¹Ð» index.html"
echo "   3. ÐÐ°ÑÐ»Ð°Ð¶Ð´Ð°Ð¹Ñ‚ÐµÑÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð¾Ð¼!"
echo ""
echo "ðŸ’¡ Ð”Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¿Ð¾Ñ€Ñ‚Ñƒ: ./run.sh 9090"
echo ""