# Makefile –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
CC = gcc
CFLAGS = -Wall -Wextra -g -Ibackend/src -I. -D_GNU_SOURCE
LDFLAGS = -lpthread -lm

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
TEST_DIR = tests
BACKEND_SRC = backend/src
BACKEND_BUILD = backend/build

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –±—ç–∫–µ–Ω–¥–∞ (–ù–ï –≤–∫–ª—é—á–∞–µ–º main.c!)
REAL_SOURCES = $(BACKEND_SRC)/proc_parser.c \
               $(BACKEND_SRC)/json_formatter.c \
               $(BACKEND_SRC)/history.c \
               $(BACKEND_SRC)/server.c \
               $(BACKEND_SRC)/system_info.c
# main.c –ù–ï –≤–∫–ª—é—á–∞–µ–º - —É –Ω–∞—Å —Å–≤–æ–π main –≤ test_runner.c

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤
TEST_SOURCES = $(TEST_DIR)/test_runner.c \
               $(TEST_DIR)/test_proc_parser.c \
               $(TEST_DIR)/test_json_formatter.c \
               $(TEST_DIR)/test_history.c \
               $(TEST_DIR)/test_server_mock.c

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
REAL_OBJECTS = $(REAL_SOURCES:$(BACKEND_SRC)/%.c=$(BACKEND_BUILD)/%.o)
TEST_OBJECTS = $(TEST_SOURCES:$(TEST_DIR)/%.c=$(TEST_DIR)/%.o)

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN = \033[0;32m
RED = \033[0;31m
BLUE = \033[0;34m
YELLOW = \033[1;33m
NC = \033[0m

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(BACKEND_BUILD):
	@mkdir -p $(BACKEND_BUILD)

# –¶–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
all: prepare test_runner

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
prepare: $(BACKEND_BUILD)
	@echo "$(BLUE)üìÅ Build directory created$(NC)"

# –õ–∏–Ω–∫–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–∞–Ω–Ω–µ—Ä–∞
test_runner: $(TEST_OBJECTS) $(REAL_OBJECTS)
	@$(CC) $(TEST_OBJECTS) $(REAL_OBJECTS) -o $@ $(LDFLAGS)
	@echo "$(GREEN)‚úÖ Test runner created: $@$(NC)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
$(BACKEND_BUILD)/%.o: $(BACKEND_SRC)/%.c | $(BACKEND_BUILD)
	@$(CC) $(CFLAGS) -c $< -o $@
	@echo "  $(YELLOW)Compiled:$(NC) $<"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
$(TEST_DIR)/%.o: $(TEST_DIR)/%.c
	@$(CC) $(CFLAGS) -c $< -o $@
	@echo "  $(YELLOW)Compiled:$(NC) $<"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@rm -rf $(BACKEND_BUILD) $(TEST_DIR)/*.o test_runner
	@echo "$(GREEN)‚úÖ Cleaned up$(NC)"

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
run: test_runner
	@echo "$(BLUE)üöÄ Running tests...$(NC)\n"
	@./test_runner

# –ó–∞–ø—É—Å–∫ —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤–∞—Ä–Ω–∏–Ω–≥–æ–≤
run-quiet: CFLAGS += -Wno-unused-variable -Wno-type-limits
run-quiet: test_runner
	@echo "$(BLUE)üöÄ Running tests (quiet mode)...$(NC)\n"
	@./test_runner

# –ó–∞–ø—É—Å–∫ —Å valgrind
valgrind: test_runner
	@echo "$(BLUE)üîç Running tests with valgrind...$(NC)\n"
	@valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./test_runner

# –ü–æ–º–æ—â—å
help:
	@echo "$(BLUE)üìã Available commands:$(NC)"
	@echo "  make all        - –°–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
	@echo "  make run        - –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  make run-quiet  - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä—É—è –≤–∞—Ä–Ω–∏–Ω–≥–∏"
	@echo "  make clean      - –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  make valgrind   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–∞–º—è—Ç–∏"
	@echo "  make help       - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"

.PHONY: all clean run run-quiet valgrind help prepare